# --- Imports ---
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, ElementClickInterceptedException
from selenium.webdriver.common.keys import Keys
import time

# --- Configuration ---
ADMIN_USER = ''
ADMIN_PASSWORD = ''
NEW_USER_PASSWORD = ''

BASE_USER_PREFIX = 'stress_'
START_USER_NUM = 1703
END_USER_NUM = 1900
BASE_URL = 'https://stressprepaidcoreadmin2.corecard.in/auth/login'


# --- Function Definitions ---
def robust_click(driver, locator, timeout=20):
    try:
        element = WebDriverWait(driver, timeout).until(EC.element_to_be_clickable(locator))
        driver.execute_script("arguments[0].scrollIntoView({block: 'center', inline: 'nearest'});", element)
        time.sleep(0.5)
        element.click()
        return True
    except ElementClickInterceptedException:
        print(f"Standard click failed for locator '{locator}'. Retrying with JavaScript.")
        try:
            element = WebDriverWait(driver, timeout).until(EC.presence_of_element_located(locator))
            driver.execute_script("arguments[0].click();", element)
            return True
        except Exception as e:
            print(f"JavaScript click also failed for locator '{locator}': {e}")
            return False
    except Exception as e:
        print(f"Could not click element with locator '{locator}': {e}")
        return False

def login(driver, username, password):
    driver.get(BASE_URL)
    wait = WebDriverWait(driver, 30)
    try:
        wait.until(EC.presence_of_element_located((By.ID, 'txtUserID'))).send_keys(username)
        driver.find_element(By.NAME, 'Password').send_keys(password)
        robust_click(driver, (By.XPATH, '//button[@data-testid="login-button"]'))

        # Wait for either dashboard or password change screen
        success_locator = (By.XPATH, "//span[text()='Administration'] | //*[@data-testid='txtCurrentPassword']")
        WebDriverWait(driver, 30).until(EC.presence_of_element_located(success_locator))
        print(f"Successfully logged in as '{username}'.")
        return True
    except Exception as e:
        print(f"Login failed for user '{username}'. Error: {e}")
        return False

def set_date_field(driver, locator, date_string):
    print(f"Attempting to set date '{date_string}' for locator '{locator}'...")
    try:
        element = WebDriverWait(driver, 10).until(EC.presence_of_element_located(locator))
        driver.execute_script("arguments[0].scrollIntoView({block: 'center'});", element)
        time.sleep(0.5)
        element.click()
        time.sleep(0.2)
        element.send_keys(Keys.CONTROL + "a", Keys.DELETE)
        element.send_keys(date_string)
        element.send_keys(Keys.TAB)
        time.sleep(0.5)
        current_value = element.get_attribute("value")
        if date_string in current_value:
            print("Date set successfully using send_keys.")
            return True
        else:
            raise Exception("Direct send_keys did not set date.")
    except Exception as e:
        print(f"Direct send_keys failed: {e}. Trying JavaScript fallback...")
        try:
            element = WebDriverWait(driver, 10).until(EC.presence_of_element_located(locator))
            js_script = """
                var input = arguments[0];
                var date = arguments[1];
                input.value = date;
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
            """
            driver.execute_script(js_script, element, date_string)
            time.sleep(0.5)
            current_value = element.get_attribute("value")
            if date_string in current_value:
                print("Date set successfully using JavaScript.")
                return True
            else:
                print("JavaScript did not set the date correctly.")
                return False
        except Exception as e2:
            print(f"FATAL: Could not set date. {e2}")
            return False


# --- Main Script ---
print("--- Script Starting ---")

for i in range(START_USER_NUM, END_USER_NUM + 1):
    user_id = f"{BASE_USER_PREFIX}{str(i)}"
    print(f"\n=== Processing User: {user_id} ===")

    driver = webdriver.Chrome()
    driver.maximize_window()

    try:
        print("Performing admin login...")
        if not login(driver, ADMIN_USER, ADMIN_PASSWORD):
            print(f"FATAL: Admin login failed. Skipping user {user_id}.")
            continue

        # --- Step 1: Navigate to Create User ---
        print("Navigating to user creation page...")
        robust_click(driver, (By.XPATH, "//span[text()='Administration']"))
        robust_click(driver, (By.XPATH, "//span[text()='User']"))
        robust_click(driver, (By.XPATH, "//span[text()='Create User']"))
        WebDriverWait(driver, 20).until(EC.visibility_of_element_located((By.ID, 'txtUserID')))

        # --- Step 2: Fill User Details ---
        print("Selecting business name...")
        robust_click(driver, (By.CSS_SELECTOR, "#ddlBusinessName .p-multiselect-trigger"))
        filter_input = WebDriverWait(driver, 10).until(EC.visibility_of_element_located((By.CSS_SELECTOR, "div.p-multiselect-header input.p-multiselect-filter")))
        filter_input.send_keys("ISC India")
        WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "//li[.='ISC India']"))).click()
        time.sleep(2)

        print("Filling user details...")
        driver.find_element(By.ID, 'txtUserID').send_keys(user_id)
        driver.find_element(By.ID, 'txtFirstName').send_keys('Abhishek')
        driver.find_element(By.ID, 'txtLastName').send_keys('kushwaha')
        driver.find_element(By.ID, 'txtEmailAddress').send_keys('abhishek.kushwaha@corecard.com')

        if not set_date_field(driver, (By.CSS_SELECTOR, "input[name='DateOfBirth']"), '01/01/1999'):
            raise Exception("Failed to set Date of Birth.")

        driver.find_element(By.ID, 'txtAddressLine1').send_keys('Address 1')
        driver.find_element(By.ID, 'txtAddressLine2').send_keys('Address 2')
        driver.find_element(By.ID, 'city').send_keys('New York')
        driver.find_element(By.ID, 'txtPostalCode').send_keys('12345')

        print("Selecting country/state...")
        robust_click(driver, (By.CSS_SELECTOR, "#ddlCountry .p-dropdown-trigger"))
        robust_click(driver, (By.XPATH, "//li[normalize-space()='United States']"))
        time.sleep(1)
        robust_click(driver, (By.CSS_SELECTOR, "#ddlState .p-dropdown-trigger"))
        robust_click(driver, (By.XPATH, "//li[normalize-space()='Alabama']"))

        print("Submitting form...")
        if not robust_click(driver, (By.ID, 'btnSubmit')):
            raise Exception("Submit button click failed.")

        # --- Step 3: Get Generated Password ---
        print("Waiting for generated password...")
        generated_password_element = WebDriverWait(driver, 10).until(EC.visibility_of_element_located((By.ID, 'generatedPassword')))
        generated_password = generated_password_element.get_attribute("value")
        if not generated_password:
            raise Exception("Password not retrieved.")
        print(f"User '{user_id}' created. Password: {generated_password}")

        # --- Step 4: Login as New User ---
        print("Logging in as new user to change password...")
        if not login(driver, user_id, generated_password):
            raise Exception("New user login failed.")

        # --- Step 5: Change Password ---
        print("Changing password...")
        WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.CSS_SELECTOR, '[data-testid="txtCurrentPassword"]'))).send_keys(generated_password)
        driver.find_element(By.CSS_SELECTOR, '[data-testid="txtNewPassword"]').send_keys(NEW_USER_PASSWORD)
        driver.find_element(By.CSS_SELECTOR, '[data-testid="txtConfirmPassword"]').send_keys(NEW_USER_PASSWORD)

    

        #====================================================

        # Security question dropdown
        try:
            WebDriverWait(driver, 60).until(EC.element_to_be_clickable((By.CSS_SELECTOR, '.p-dropdown-trigger')))
            trigger = driver.find_element(By.CSS_SELECTOR, '.p-dropdown-trigger')
            trigger.click()

            WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.CSS_SELECTOR, '.p-dropdown-item')))
            items = driver.find_elements(By.CSS_SELECTOR, '.p-dropdown-item')

            for item in items:
                if "What city were you born in?" in item.text:
                    item.click()
                    break
        except Exception as e:
            print(f"Dropdown selection failed: {e}")

        WebDriverWait(driver, 60).until(EC.presence_of_element_located((By.CSS_SELECTOR, '[data-testid="txtSecurityAnswer0"]')))
        security_answer_field = driver.find_element(By.CSS_SELECTOR, '[data-testid="txtSecurityAnswer0"]')
        security_answer_field.send_keys("a")

        try:
            set_date_field(driver, (By.CSS_SELECTOR, "input[name='DateOfBirth'][role='combobox']"), "01/01/1999")
        except:
            pass

        print("Submitting password change...")
        if not robust_click(driver, (By.ID, 'btnSubmit')):
            raise Exception("Submit password change failed.")
        WebDriverWait(driver, 10).until(EC.url_contains("auth/login"))
        print(f" Password changed successfully for {user_id}.")

    except Exception as e:
        print(f" ERROR for {user_id}: {e}")
        screenshot_file = f"error_{user_id}_{int(time.time())}.png"
        driver.save_screenshot(screenshot_file)
        print(f"Screenshot saved: {screenshot_file}")

    finally:
        driver.quit()

print("\n--- All users processed. Script finished. ---")
