# --- Imports ---
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import ElementClickInterceptedException
from selenium.webdriver.common.keys import Keys
import time

# --- Configuration ---
ADMIN_USER = ''
ADMIN_PASSWORD = ''
NEW_USER_PASSWORD = ''

BASE_USER_PREFIX = 'stress_CPP_'
START_USER_NUM = 115
END_USER_NUM = 500
BASE_URL = 'https://stressprepaidcoreadmin2.corecard.in/auth/login'

# --- Helper Functions ---
def robust_click(driver, locator, timeout=20):
    try:
        el = WebDriverWait(driver, timeout).until(EC.element_to_be_clickable(locator))
        driver.execute_script("arguments[0].scrollIntoView({block:'center'});", el)
        time.sleep(0.4)
        el.click()
        return True
    except ElementClickInterceptedException:
        print(f"Click failed, retrying with JS: {locator}")
        try:
            el = WebDriverWait(driver, timeout).until(EC.presence_of_element_located(locator))
            driver.execute_script("arguments[0].click();", el)
            return True
        except:
            return False
    except:
        return False


def login(driver, username, password):
    driver.get(BASE_URL)
    wait = WebDriverWait(driver, 30)

    try:
        wait.until(EC.presence_of_element_located((By.ID, "txtUserID"))).send_keys(username)
        driver.find_element(By.NAME, "Password").send_keys(password)
        robust_click(driver, (By.XPATH, '//button[@data-testid="login-button"]'))

        success = (By.XPATH, "//span[text()='Administration'] | //*[@data-testid='txtCurrentPassword']")
        wait.until(EC.presence_of_element_located(success))
        print(f"Logged in as {username}")
        return True
    except Exception as e:
        print(f"Login failed for {username}: {e}")
        return False


def set_date_field(driver, locator, date):
    try:
        el = WebDriverWait(driver, 15).until(EC.presence_of_element_located(locator))
        driver.execute_script("arguments[0].scrollIntoView({block:'center'});", el)
        time.sleep(0.3)
        el.click()
        el.send_keys(Keys.CONTROL + "a", Keys.DELETE)
        el.send_keys(date)
        el.send_keys(Keys.TAB)
        return True
    except:
        return False


# --- Main Script ---
print("\n--- Script Starting ---")

for i in range(START_USER_NUM, END_USER_NUM + 1):
    user_id = f"{BASE_USER_PREFIX}{i}"
    print(f"\n==============================")
    print(f"Processing User: {user_id}")
    print(f"==============================")

    driver = webdriver.Chrome()
    driver.maximize_window()
    wait = WebDriverWait(driver, 25)

    try:
        # Admin Login
        if not login(driver, ADMIN_USER, ADMIN_PASSWORD):
            print("Admin login failed. Skipping user.")
            continue

        # Navigate to Administration
        robust_click(driver, (By.XPATH, "//span[text()='Administration']"))

        # Business Name
        robust_click(driver, (By.CSS_SELECTOR, "#ddlBusinessName .p-multiselect-trigger"))

        filter_input = wait.until(
            EC.visibility_of_element_located(
                (By.CSS_SELECTOR, "div.p-multiselect-header input.p-multiselect-filter")
            )
        )
        filter_input.send_keys("ISC India")

        wait.until(EC.element_to_be_clickable((By.XPATH, "//li[.='ISC India']"))).click()

        # User ID
        user_id_field = wait.until(
            EC.element_to_be_clickable((By.CSS_SELECTOR, "input[data-testid='txtUserId']"))
        )
        user_id_field.clear()
        user_id_field.send_keys(user_id)

        # Personal Info
        driver.find_element(By.ID, "txtFirstName").send_keys("Abhishek")
        driver.find_element(By.ID, "txtLastName").send_keys("kushwaha")
        driver.find_element(By.ID, "txtEmailAddress").send_keys("abhishek.kushwaha@corecard.com")

        set_date_field(driver, (By.CSS_SELECTOR, "input[name='DateOfBirth']"), "01/01/1999")

        wait.until(EC.presence_of_element_located((By.ID, "txtAddressLine1"))).send_keys("Address 1")
        wait.until(EC.presence_of_element_located((By.ID, "txtAddressLine2"))).send_keys("Address 2")
        wait.until(EC.presence_of_element_located((By.ID, "city"))).send_keys("New York")
        wait.until(EC.presence_of_element_located((By.ID, "txtPostalCode"))).send_keys("12345")

        # Country & State
        robust_click(driver, (By.CSS_SELECTOR, "#ddlCountry .p-dropdown-trigger"))
        robust_click(driver, (By.XPATH, "//li[normalize-space()='United States']"))

        robust_click(driver, (By.CSS_SELECTOR, "#ddlState .p-dropdown-trigger"))
        robust_click(driver, (By.XPATH, "//li[normalize-space()='Alabama']"))

        # Submit Create User
        robust_click(driver, (By.ID, "btnSubmit"))

        # -------------------------------
        # FIX 1: Generate Password
        # -------------------------------
        generated_password = wait.until(
            EC.presence_of_element_located((By.ID, "txtGeneratedPassword"))
        ).get_attribute("value")

        print(f"Generated Password: {generated_password}")

        # Login as new user
        if not login(driver, user_id, generated_password):
            raise Exception("New user login failed!")

        # Change Password
        wait.until(
            EC.presence_of_element_located((By.CSS_SELECTOR, '[data-testid="txtCurrentPassword"]'))
        ).send_keys(generated_password)

        driver.find_element(By.CSS_SELECTOR, '[data-testid="txtNewPassword"]').send_keys(NEW_USER_PASSWORD)
        driver.find_element(By.CSS_SELECTOR, '[data-testid="txtConfirmPassword"]').send_keys(NEW_USER_PASSWORD)

        # -------------------------------
        # FIX 2: Select FIRST Security Question
        # -------------------------------
        print("Selecting Security Question...")

        # Click dropdown label OR trigger
        try:
            dropdown = wait.until(
                EC.element_to_be_clickable((By.CSS_SELECTOR, ".p-dropdown-label"))
            )
            dropdown.click()
        except:
            trigger = wait.until(
                EC.element_to_be_clickable((By.CSS_SELECTOR, ".p-dropdown-trigger"))
            )
            trigger.click()

        time.sleep(0.5)

        # Select FIRST question
        options = wait.until(
            EC.presence_of_all_elements_located((By.CSS_SELECTOR, ".p-dropdown-item"))
        )
        options[0].click()
        print("Security Question Selected: First Option")

        # Security Answer
        wait.until(
            EC.presence_of_element_located((By.CSS_SELECTOR, '[data-testid="txtSecurityAnswer0"]'))
        ).send_keys("bhopal")

        set_date_field(driver, (By.CSS_SELECTOR, "input[name='DateOfBirth'][role='combobox']"), "01/01/1999")

        robust_click(driver, (By.ID, "btnSubmit"))
        wait.until(EC.url_contains("auth/login"))

        print(f"✅ COMPLETED: {user_id}")

    except Exception as e:
        print(f"❌ ERROR for {user_id}: {e}")

    finally:
        driver.quit()

print("\n--- All Users Processed Successfully ---")
